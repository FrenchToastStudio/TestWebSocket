
@{
    ViewBag.Title = "Lobby";
}

<style>
    #creerLobby {
        display: block;
    }

    #zonePhrase {
        display: none;
    }

    #zoneVote {
        display: none;
    }

    #zoneLeaderBoard {
        display: none;
    }
    
    #zoneRésultat {
        display: none;
    }

    #zoneDébut {
        display: none;
    }

    #zoneFinPartie {
        display: none;
    }
    .row {
        margin-right: 0px !important;
        margin-left: 0px !important;
    }

</style>
<div id="overlay">
    <div class="jumbotron container-fluid">
        <h1 id="idPartie" class="text-center">Lobby</h1>
    </div>
    <div class="row stuff-after-jumbo" id="creerLobby">
        <button type="button" id="bCreerLobby" value="Creer le salon" class="btn btn-success btn-block btn-lg mx-15">Creer Salon</button>
    </div>
    <div class="row" id="zoneDébut">
        <ul id="connecte"></ul>
    </div>
    <div class="row stuff-after-jumbo" id="zonePhrase">
        <h2>Les joueurs dans cette ronde :</h2>
        <ul id="connectesLoby"></ul><br />
        <h2>Entrez ce que cette phrase vous inspire </h2>
        <h2 id="phaseACompleter"></h2>
    </div>
    <div class="row" id="zoneVote">
        <h2>Veuillez voter sur la phrase qui vous inspire le plus! </h2>
        <span id="phaseACompleter"></span>
        <ul id="phraseRecus"></ul>
        <ul id="connectesVote"></ul>
    </div>
    <div class="row" id="zoneResultat">
        <ul id="votes"></ul>
    </div>
    <div class="row" id="zoneFinPartie">
        <h2>Merci d'Avoir joué!</h2>
    </div>
    <div class="row" id="zoneLeaderBoard">
        <ul id="leaderboard"></ul>
    </div>
    <div class="row stuff-after-jumbo" id="zonePublic">
        <h4 id="nbSpectarteur">Nb de Spectateur: 0</h4>
    </div>
</div>

    <script>
        var webSocket = null;
        var idPartie = null;
        var nbSpectateur = 0;
        var joueurs = [];

        //Permet d'ajouter un joueru connecter dans la liste du lobby
        function ajouterConnecte(nom) {
            joueurs.push(nom);
            document.getElementById('connecte').innerHTML += "<li class='membre' id='connecte" + nom + "'>" + nom + "</li>";
            document.getElementById('connectesVote').innerHTML += "<li class='membre' id='connecteVote" + nom + "'>" + nom + "</li>";
            document.getElementById('connectesLoby').innerHTML += "<li class='membre' id='connecteLoby" + nom + "'>" + nom + "</li>";
        }

        //Ajouter un specteur a la liste
        function ajouterSpectateur() {
            console.log("ok shawty");
            nbSpectateur += 1;
            document.getElementById('nbSpectarteur').innerHTML = "Nb de Spectateur: " + nbSpectateur;
        }

        //Envoi le vote 
        function envoyerVote(nom) {
            document.getElementById(msg.Data).style['display'] = "block";
        }

        //Affiche le leaderboard dans le html
        function afficherLeaderboard(leaderboard) {
            document.getElementById('leaderboard').innerHTML = "";
            console.log(leaderboard);
            document.getElementById('zoneLeaderBoard').style['display'] = "block";
            leaderboard.forEach(element => document.getElementById('leaderboard').innerHTML += "<li class='participant' id='" + element.Nom + "'>" + element.Nom + " : " + element.pointage + "</li>");
        }

        //lance la prochaine round et affihe la phrase dans le html
        function prochaineRonde(phrase) {
            console.log(phrase);
            document.getElementById('zoneDébut').style['display'] = "none";
            document.getElementById('zonePhrase').style['display'] = "block";
            document.getElementById('phaseACompleter').innerHTML = phrase;
        }

        //préviens le serveur d'un phrase qui a été completer
        function prevenirPhraseCompleter() {
            var msg = {
                Categorie: "JEU", Type: "PHRASECOMPLETER"
            }
            webSocket.send(JSON.stringify(msg));
        }

        //préviens ls serveur que la partie a débuter
        function commencerPartie() {
            var msg = {
                Categorie: "JEU", Type: "START"
            }
            webSocket.send(JSON.stringify(msg));
        }

        //affiche la phase de vote dans le html 
        function afficherPhaseVote() {
            document.getElementById('zonePhrase').style['display'] = "none";
            document.getElementById('zoneVote').style['display'] = "block";
        }

        //préviens le serveur de lancer la prochaine ronde
        function lancerProchaineRonde() {
            document.getElementById('zoneLeaderBoard').style['display'] = 'none';
            var msg = {
                Categorie: "JEU", Type: "START"
            }
            webSocket.send(JSON.stringify(msg));
        }

        //préviens le servuer que le tour est terminer
        function lancerAfficherLeaderboard() {
            var msg = {
                Categorie: "JEU", Type: "TOURTERMINER"
            }
            webSocket.send(JSON.stringify(msg));
        }

        //permet de créer le lobby
        document.getElementById('bCreerLobby').onclick = function () {
            if (webSocket == null) {

                var URL = "ws://localhost:57339/api/websocket/lobby/";
                webSocket = new WebSocket(URL)
                webSocket.onopen = function () {
                    document.getElementById('creerLobby').style['display'] = "none";
                    document.getElementById('zoneDébut').style['display'] = "block";
                }
                webSocket.onclose = function (event) {
                    document.getElementById('zoneDébut').style['display'] = "none";
                    document.getElementById('zoneLeaderBoard').style['display'] = "none";
                    document.getElementById('creerLobby').style['display'] = "block";
                }

                webSocket.onerror = function (event) {
                    //document.getElementById('console').innerHTML += "ERREUR: " + event.message + "<br />";
                }

                webSocket.onmessage = function (event) {
                    var msg = JSON.parse(event.data);

                    switch (msg.Categorie) {
                        case "JEU":
                            switch (msg.Type) {
                                //lance la prochaine rond
                                case "NEXTROUND":
                                    var partie = msg.Data;
                                    document.getElementById('zonePhrase').style['display'] = 'none';
                                    document.getElementById('zoneVote').style['display'] = 'none';
                                    document.getElementById('zoneLeaderBoard').style['display'] = 'none';
                                    prochaineRonde(partie.PhraseACompleter);
                                    break;
                                //cas qui prévien le serveur lorsqu'un joueur compelte sa phrase
                                case "PHRASECOMPLETER":
                                    prevenirPhraseCompleter();
                                    break;
                                //Cas qui permet d'afficher les vote
                                case "AFFICHERVOTE":
                                    votes = msg.Data; zoneVote
                                    document.getElementById('zonePhrase').style['display'] = 'none';
                                    document.getElementById('zoneVote').style['display'] = 'none';
                                    document.getElementById('zoneResultat').style['display'] = 'block';
                                    for (var key in votes) {
                                        document.getElementById('votes').innerHTML += "<li class='votes'>" + key + ": " + votes[key] + "</li>";
                                    }
                                    setTimeout(lancerAfficherLeaderboard, 10000)
                                    break;
                                //cas pour joueur qui vote
                                case "JOUEURVOTE":
                                    ajouterJoueurVote(msg.data);
                                    break;
                                //cas pour débuter la partie
                                case "DEBUTER":
                                    commencerPartie();
                                    break;
                                //cas pour lancer la phase de vote
                                case "PHASEVOTE":
                                    afficherPhaseVote()
                                    break;
                                //cas qui permet au joueuer de completer un vote
                                case "VOTER":
                                    var msg = {
                                        Categorie: "JEU", Type: "VOTECOMPLETER", Data: msg.Data
                                    }
                                    webSocket.send(JSON.stringify(msg));
                                    break;
                                //cas qui affiche le leaderboard des joueur
                                case "LEADERBOARD":
                                    document.getElementById('zonePhrase').style['display'] = 'none';
                                    document.getElementById('zoneVote').style['display'] = 'none';
                                    document.getElementById('zoneResultat').style['display'] = 'none';
                                    document.getElementById('zoneLeaderBoard').style['display'] = 'block';
                                    afficherLeaderboard(msg.Data);
                                    setTimeout(lancerProchaineRonde, 10000)
                                    break;
                                //cas qui permet de terminer la partie
                                case "PARTIETERMINER":
                                    document.getElementById('zonePhrase').style['display'] = 'none';
                                    document.getElementById('zoneVote').style['display'] = 'none';
                                    document.getElementById('zoneResultat').style['display'] = 'none';
                                    document.getElementById('zoneFinPartie').style['display'] = 'block';
                                    document.getElementById('zoneLeaderBoard').style['display'] = 'block';
                                    afficherLeaderboard(msg.Data);
                                    break;
                            }
                            break;
                        case "CONNECTER":
                            switch (msg.Type) {
                                case "ADD":
                                    var msg = {
                                        Categorie: "CONNECTER", Type: "ADDJOUEUR", Data: msg.Data
                                    }
                                    webSocket.send(JSON.stringify(msg));
                                    break;
                                //cas pour ajouter un nouveau joueur
                                case "NOUVEAUJOUEUR":
                                    console.log("passe ici");
                                    ajouterConnecte(msg.Data);
                                    break;
                                //cas pour ajouter un nouveau spectateur
                                case "NOUVEAUSPECTATEUR":
                                    ajouterSpectateur();
                                    break;
                            }
                            break;
                        case "LOBBY":
                            switch (msg.Type) {
                                case "DEBUTER":
                                    document.getElementById('idPartie').innerHTML += ": " + msg.Data;
                                    break;
                            }
                            break;
                    }
                }
            }
        }
    </script>
